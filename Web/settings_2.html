<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accout Settings</title>
    <link rel="stylesheet" href="style.css">
</head>
<body onload="getValuesFromDatabase()">
    <div class= "settingsBackground">
    </div>
    <div class = "backgroundDim">
    </div>
    
    <nav class = "navigationMenu">
    <div>
    <ul>
        <li><a href="home.html" title="Home"> Home </a></li>
        <li><a href="linking.html" title="Linking"> Linking </a></li>
        <li><a href="history.html" title="My History"> My History </a></li>
        <li><a href="#" title="File Manager"> File Manager</a></li>
        <li><a href="#" title="Account Settings"> Account Settings</a></li>
        <li><a href="prehome.html" title="Logout"> Logout </a></li>
    </ul>
    </div>
    </nav>

    <div class = "settingsFrame">

        <div class = "settingsMenu">
            <nav class = "navigationSettings">
            <div>
            <ul>
                <li><a href="settings_1.html">
                <img src="./images/settings/personal_info2.svg" class = "ico" alt = "logo personal info">
                Personal Info 
                </a></li>

                <li><a href="settings_2.html">
                <img src="./images/settings/account_security.svg" class = "ico" alt = "logo account security"> 
                Account Security 
                </a></li>

                <li><a href="settings_3.html">
                <img src="./images/settings/clouds_settings.svg" class = "ico" alt = "logo clouds settings"> 
                Clouds Settings 
                </a></li>
                
                <li><a href="settings_4.html">
                <img src="./images/settings/advanced_settings.svg" class = "ico" alt = "logo advanced settings"> 
                Bandwidth
                </a></li>
            </ul>
            </div>
            </nav>
        </div>


        <div class = "settingsContent">
        <div class = "settingsPersonalInfo">
        
            <div class = "settingsTopSide">
                <p>Account Security</p>
                <button class="button" onclick="applyValues()">Apply</button>
            </div>

            <div class = "settingsBotSide">
            <div class = "flexContainerSettings2">
                <div> <br>
                <label for="email"> Email </label>
                <input type="text" id="email" name="email" value="">
                </div>

                <div> <br>
                <label for="newPassword"> New Password </label>
                <input type="password" id="newPassword" name="newPassword" value="">
                </div>

                <div> <br>
                <label for="oldPassword"> Old Password </label>
                <input type="password" id="oldPassword" name="oldPassword" value="">
                </div>
            </div>
            </div>
        </div>
        </div>

    </div>

    <script>
        async function digestMessage(message) {
            const msgUint8 = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        async function getValuesFromDatabase()
        {
            // aici se vor seta field-urile din aceasta pagina, flower power

            let userID = localStorage.getItem("stol_owner_id");


            var url = 'http://127.0.0.1:3000/' + userID + '/user/2';
            const response = await fetch(url, {
                method: 'GET'
            });
            const myJson = await response.json();

            console.log(myJson);

            // here it must be modified to use the result json

            document.getElementById("email").value = myJson["email"];

        }

        async function applyValues()
        {
            let email = document.getElementById("email").value;
            let newPassword = document.getElementById("newPassword").value;
            let oldPassword = document.getElementById("oldPassword").value;

            let userID = localStorage.getItem("stol_owner_id");

            const hashed_old_password = await digestMessage(oldPassword);
            const hashed_new_password = await digestMessage(newPassword);


            var url = 'http://127.0.0.1:3000/' + userID + '/user/2';
            console.log(url);
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({email : email, hashed_old_password : hashed_old_password, hashed_new_password : hashed_new_password})
            });
            const myJson = await response.json();

            console.log(myJson);

        }
    </script>

</body>
</html>