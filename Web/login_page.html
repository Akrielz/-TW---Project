<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Login Page </title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class = "loginBackground">
    </div>
    <div class = "backgroundDim">
    </div>

    <div class = "loginForm">

        <div class = "loginTitle">
            <p> <u> <b> Sign In </b> </u> </p>
        </div>

        <div class = "inputFormLogin"> 
        <form>
            <label for = "username"> Username </label>
            <input type="text" id="username" name="username">
            
            <label for = "password"> Password </label>
            <input type="password" id="password" name="password">
        </form>
        </div>

        <script>
            async function digestMessage(message) {
                const msgUint8 = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            }

            async function loginFunction()
            {
                let username = await document.getElementById("username").value;
                let password = await document.getElementById("password").value;

                const hashed_password = await digestMessage(password);

                await console.log(username);
                await console.log(password);
                await console.log(hashed_password);

                let url = 'http://127.0.0.1:3000/login';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin' : '*'
                    },
                    body: JSON.stringify({email : "", username : username, hashed_password : hashed_password})
                });
                const myJson = await response.json();

                console.log(myJson)
                if(myJson['Status'] === "OK")
                {
                    setTimeout(() => {
                        localStorage.setItem('stol_owner_id', myJson["owner_id"]);
                        localStorage.setItem('stol_user_root', myJson["root"]);
                        localStorage.setItem('stol_current_folder', myJson["root"]);

                        window.location.href = "home.html";
                    }, 3000);
                }

            }
        </script>

        <div class= "loginButtonSection">
        <div class = "flexContainer">
            <div>
                <a class = "loginButton" onclick="loginFunction()">
                    <i class="arrow"> </i> 
                </a>
            </div>
        </div>
        </div>

        <div class = "loginRedirect">
            <p> <a href="prehome.html"> Back to PreHome </a> </p>
            <p> <a href="register_page.html"> Don't have an account? </a> </p>
        </div>

    </div>

</html>